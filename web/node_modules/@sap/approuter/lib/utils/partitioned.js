'use strict';
const cookieUtils = require('./cookie-utils');
const cookie = require('cookie');
module.exports = (middleware) => (req, res, next) => {
  try {
    if (cookieUtils.shouldPartitionCookie(req)) {
      const re = /;\s*Partitioned\s*(;|$)/i;
      const partitioned = ' Partitioned';
      const maxAge = 'Max-Age';
      const _setHeader = res.setHeader;
      const sessionCookieName = req.app && req.app.get('cookieName');
      res.setHeader = function (key, val) {
        if (key && key.toLowerCase() === 'set-cookie' && Array.isArray(val)) {
          val = val.map((v) => {
            const parsedCookie = cookie.parse(v);
            // Skip expired session cookies
            if (parsedCookie[sessionCookieName] && parsedCookie[maxAge] === '0') {
              return v;
            }
            return v.match(re) ? v : v + (v.endsWith(';') ? partitioned : ';' + partitioned);
          });
        }
        return _setHeader.call(res, key, val);
      };
    }
    return middleware(req, res, next);
  } catch (err){
    next(err);
  }
};